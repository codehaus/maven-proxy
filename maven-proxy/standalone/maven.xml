<project default="jar:install"
  xmlns:j="jelly:core"
  xmlns:ant="jelly:ant">

  <goal name="build:snapshot">
    <attainGoal name="uberjar"/>
    <attainGoal name="build:snapshot:dist"/>
  </goal>
  
  <pregoal name="test:test-resources">
    <mkdir dir="target/repo"/>
  </pregoal>
  
  <goal name="build:snapshot:dist">
    <j:set var="distBase">target/dist/maven-proxy-${pom.currentVersion}</j:set>

    <mkdir dir="${distBase}"/>
    <mkdir dir="${distBase}/lib"/>
  	<copy file="target/maven-proxy-standalone-${pom.currentVersion}.jar" todir="${distBase}/lib"/>
   	<j:forEach var="lib" items="${pom.artifacts}">
      <j:set var="dep" value="${lib.dependency}"/>
      <j:if test="${dep.getProperty('dist')=='true'}">
        <ant:copy todir="${distBase}/lib" file="${lib.path}"/>  
      </j:if>  
    </j:forEach>
  
    <mkdir dir="${distBase}/bin"/>
  	<ant:copy todir="${distBase}/bin">
	  <fileset dir="src/bin">
        <include name="*"/>
	  </fileset>
    </ant:copy>
    
    <zip destfile="target/invigilator-${pom.currentVersion}-distribution.zip"
      basedir="target/dist"
      update="true"
    />
  
    <copy file="target/maven-proxy-standalone-SNAPSHOT.zip"
          todir="/dist/maven-proxy/distributions/"/>
  </goal>
  
  <goal name="run" prereqs="jar:jar">
    <mkdir dir="target/repo"/>
  	<java
      classname="org.apache.maven.proxy.standalone.Standalone"
      fork="true">
        <arg value="src/test/test.properties"/>
        <classpath>
          <path refid="maven-classpath"/>
          <path refid="maven.dependency.classpath"/>
          <pathelement path="target/classes"/>
        </classpath>
    </java>
  </goal>
</project>
